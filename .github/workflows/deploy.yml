name: ðŸš€ DÃ©ploiement Automatique

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: RÃ©cupÃ©rer le code
        uses: actions/checkout@v3
      - name: ðŸ› ï¸ Debug SSH Connection
        run: |
          echo -e "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -vvv -i private_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes $SERVER_USER@$SERVER_IP "echo 'âœ… Connexion SSH rÃ©ussie !'"

      - name: ðŸ”‘ Configurer SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -i private_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "echo 'âœ… Connexion SSH rÃ©ussie !'"

      - name: Construire l'image Docker
        run: docker build -t mon-api .

      - name: Envoyer l'image Docker sur le serveur
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          scp -i private_key docker-compose.yml $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/app/
          ssh -i private_key $SERVER_USER@$SERVER_IP "
            cd /home/$SERVER_USER/app &&
            docker-compose down &&
            docker-compose pull &&
            docker-compose up -d --build
          "

      - name: ðŸ§¹ Nettoyer la clÃ© SSH
        run: rm -f private_key
