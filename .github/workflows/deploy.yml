name: 🚀 Déploiement Automatique

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le code
        uses: actions/checkout@v3
      - name: 🔑 Générer la clé privée
        run: |
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > private_key
          chmod 600 private_key
          ls -la private_key
          cat private_key | head -n 5
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Construire l'image Docker
        run: docker build -t mon-api .

      - name: 🔍 Tester la connexion SSH avant `scp`
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnow

      - name: 📂 Copier les fichiers sur le serveur
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i private_key docker-compose.yml $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/app/

      - name: Envoyer l'image Docker sur le serveur
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
          scp -i private_key docker-compose.yml $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/app/
          ssh -i private_key $SERVER_USER@$SERVER_IP "
            cd /home/$SERVER_USER/app &&
            docker-compose down &&
            docker-compose pull &&
            docker-compose up -d --build
          "

      - name: 🧹 Nettoyer la clé SSH
        run: rm -f private_key
